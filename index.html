<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JJXCAPITAL - Arbitraje P2P</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    input, button { width: 100%; padding: 0.75rem; margin: 0.5rem 0; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- Login UI -->
  <div id="auth-ui">
    <button id="btn-login">Login / Signup</button>
    <button id="btn-google">Entrar con Google</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <h2>Bienvenido, <span id="user-email"></span></h2>
    <input id="base"       placeholder="Activo base (BTC)"/>
    <input id="quote"      placeholder="Activo quote (USDT)"/>
    <input id="price-buy"  placeholder="Precio compra"/>
    <input id="price-sell" placeholder="Precio venta"/>
    <button id="btn-save-op">Guardar operación</button>
    <h3>Mis operaciones</h3>
    <ul id="ops-list"></ul>
    <button id="btn-logout">Cerrar sesión</button>
  </div>

  <!-- SDKs -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.23/auth0-spa-js.production.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>

  <!-- App logic -->
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBMHC2YuUO3mwHQORDDGZaQ84-k4tmJGjY",
      authDomain: "jjxcapital-2.firebaseapp.com",
      projectId: "jjxcapital-2",
      storageBucket: "jjxcapital-2.firebasestorage.app",
      messagingSenderId: "842768954334",
      appId: "1:842768954334:web:63248c0a432f583abf234f",
      measurementId: "G-VVYKFN4WPD"
    };

    // Inicializa Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db  = firebase.firestore();

    // Auth0 config
    let auth0 = null;
    (async () => {
      auth0 = await createAuth0Client({
        domain: "dev-o55rso550zqg13er.us.auth0.com",
        client_id: "B0Il73OK2psAqNiLZQPemVsJgk9AeCHA",
        cacheLocation: "localstorage",
        useRefreshTokens: true,
        authorizationParams: {
          redirect_uri: window.location.origin + "/JJXCAPITAL"
        }
      });

      if (window.location.search.includes("code=")) {
        await auth0.handleRedirectCallback();
        window.history.replaceState({}, document.title, "/JJXCAPITAL");
      }

      updateUI();
    })();

    // DOM references
    const uiAuth = document.getElementById("auth-ui");
    const dash   = document.getElementById("dashboard");
    const emailE = document.getElementById("user-email");

    async function updateUI() {
      const user = await auth0.getUser();
      if (user) {
        uiAuth.classList.add("hidden");
        dash.classList.remove("hidden");
        emailE.textContent = user.email;
        loadOperations(user.sub);
        document.getElementById("btn-save-op").onclick = () => saveOperation(user.sub);
      } else {
        uiAuth.classList.remove("hidden");
        dash.classList.add("hidden");
      }
    }

    document.getElementById("btn-login").onclick = () =>
      auth0.loginWithRedirect();

    document.getElementById("btn-google").onclick = () =>
      auth0.loginWithRedirect({ connection: "google-oauth2" });

    document.getElementById("btn-logout").onclick = () =>
      auth0.logout({ returnTo: window.location.origin + "/JJXCAPITAL" });

    async function saveOperation(userId) {
      const base      = document.getElementById("base").value;
      const quote     = document.getElementById("quote").value;
      const priceBuy  = parseFloat(document.getElementById("price-buy").value);
      const priceSell = parseFloat(document.getElementById("price-sell").value);
      const profit    = priceSell - priceBuy;

      try {
        await db.collection("operations").add({
          uid:       userId,
          base,
          quote,
          priceBuy,
          priceSell,
          profit,
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadOperations(userId);
      } catch (e) {
        alert("Error guardando operación: " + e.message);
      }
    }

    async function loadOperations(userId) {
      try {
        const snap = await db
          .collection("operations")
          .where("uid", "==", userId)
          .orderBy("ts", "desc")
          .get();

        document.getElementById("ops-list").innerHTML = snap.docs
          .map(doc => {
            const o = doc.data();
            return `<li>${o.base}/${o.quote} → Profit: ${o.profit}</li>`;
          })
          .join("");
      } catch (e) {
        alert("Error cargando operaciones: " + e.message);
      }
    }
  </script>
</body>
</html>
