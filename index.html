<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JJXCAPITAL âš¡ - Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; margin:0; text-align:center; }
    header { background:#FFD700; color:#000; padding:15px; font-size:1.4rem; font-weight:bold; }
    section { max-width:700px; margin:20px auto; padding:20px; border-radius:10px; }
    #auth-ui { background:#222; }
    #dashboard { background:#1a1a1a; display:none; }
    input, button { padding:10px; margin:5px; border-radius:5px; border:none; }
    button { cursor:pointer; font-weight:bold; }
    #btn-login, #btn-logout { background:#FFD700; color:#000; }
    #btn-save-op { background:#4CAF50; color:#fff; }
    ul { text-align:left; margin-top:15px; }
    li { padding:5px; border-bottom:1px solid #333; }
  </style>
</head>
<body>
  <header>JJXCAPITAL âš¡ Dashboard</header>

  <!-- Pantalla de login -->
  <section id="auth-ui">
    <h2>Iniciar sesiÃ³n</h2>
    <button id="btn-login">ðŸš€ Login con Auth0</button>
  </section>

  <!-- Dashboard tras login -->
  <section id="dashboard">
    <h2>ðŸ‘¤ Bienvenido <span id="user-email"></span></h2>
    <button id="btn-logout">ðŸšª Cerrar SesiÃ³n</button>

    <h3>Nueva operaciÃ³n</h3>
    <input id="base" placeholder="Base (ej. BTC)" />
    <input id="quote" placeholder="Quote (ej. USDT)" />
    <input id="price-buy" type="number" step="0.01" placeholder="Precio Compra" />
    <input id="price-sell" type="number" step="0.01" placeholder="Precio Venta" />
    <button id="btn-save-op">ðŸ’¾ Guardar OperaciÃ³n</button>

    <h3>ðŸ“œ Mis Operaciones</h3>
    <ul id="ops-list"></ul>
  </section>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.23/auth0-spa-js.production.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>

  <script>
    // =======================
    // ðŸ”‘ ConfiguraciÃ³n Auth0
    // =======================
    let auth0Client = null;
    async function initAuth0() {
      auth0Client = await createAuth0Client({
        domain: "dev-o55rso550zqg13er.us.auth0.com",
        client_id: "B0Il73OK2psAqNiLZQPemVsJgk9AeCHA",
        cacheLocation: "localstorage"
      });

      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        await auth0Client.handleRedirectCallback();
        window.history.replaceState({}, document.title, "/");
      }

      updateUI();
    }

    async function updateUI() {
      const user = await auth0Client.getUser();
      if (user) {
        document.getElementById("auth-ui").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("user-email").textContent = user.email;
        loadOperations(user.sub);
        document.getElementById("btn-save-op").onclick = () => saveOperation(user.sub);
      } else {
        document.getElementById("auth-ui").style.display = "block";
        document.getElementById("dashboard").style.display = "none";
      }
    }

    document.getElementById("btn-login").onclick = async () => {
      await auth0Client.loginWithRedirect({ redirect_uri: window.location.origin });
    };

    document.getElementById("btn-logout").onclick = () => {
      auth0Client.logout({ returnTo: window.location.origin });
    };

    // =======================
    // ðŸ”¥ ConfiguraciÃ³n Firebase
    // =======================
    const firebaseConfig = {
      apiKey: "AIzaSyBMHC2YuUO3mwHQORDDGZaQ84-k4tmJGjY",
      authDomain: "jjxcapital-2.firebaseapp.com",
      projectId: "jjxcapital-2",
      storageBucket: "jjxcapital-2.firebasestorage.app",
      messagingSenderId: "842768954334",
      appId: "1:842768954334:web:63248c0a432f583abf234f",
      measurementId: "G-VVYKFN4WPD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =======================
    // ðŸ’¾ Firestore funciones
    // =======================
    async function saveOperation(userId) {
      const base = document.getElementById("base").value;
      const quote = document.getElementById("quote").value;
      const priceBuy = parseFloat(document.getElementById("price-buy").value);
      const priceSell = parseFloat(document.getElementById("price-sell").value);
      const profit = priceSell - priceBuy;

      try {
        await db.collection("operations").add({
          uid: userId,
          base,
          quote,
          priceBuy,
          priceSell,
          profit,
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadOperations(userId);
      } catch (e) {
        alert("Error guardando operaciÃ³n: " + e.message);
      }
    }

    async function loadOperations(userId) {
      try {
        const snap = await db.collection("operations")
          .where("uid", "==", userId)
          .orderBy("ts", "desc")
          .get();

        document.getElementById("ops-list").innerHTML =
          snap.docs.map(doc => {
            const o = doc.data();
            return `<li>${o.base}/${o.quote} â†’ Profit: ${o.profit}</li>`;
          }).join("");
      } catch (e) {
        alert("Error cargando operaciones: " + e.message);
      }
    }

    // Inicializar Auth0
    window.onload = initAuth0;
  </script>
</body>
</html>